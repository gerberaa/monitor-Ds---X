# üîß –ö–µ—Ä—ñ–≤–Ω–∏—Ü—Ç–≤–æ –∑ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥—É

## üìã –û–≥–ª—è–¥

–¶–µ–π –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—É—î –ø–ª–∞–Ω —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥—É –∫–æ–¥–æ–≤–æ—ó –±–∞–∑–∏ Monitor DS + X Bot –¥–ª—è –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è –ø—ñ–¥—Ç—Ä–∏–º—É–≤–∞–Ω–æ—Å—Ç—ñ, –º–∞—Å—à—Ç–∞–±–æ–≤–∞–Ω–æ—Å—Ç—ñ —Ç–∞ —è–∫–æ—Å—Ç—ñ –∫–æ–¥—É.

---

## üéØ –¶—ñ–ª—ñ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥—É

1. ‚úÖ –†–æ–∑–±–∏—Ç–∏ –≤–µ–ª–∏–∫–∏–π bot.py (7,473 —Ä—è–¥–∫–∏) –Ω–∞ –º–µ–Ω—à—ñ –º–æ–¥—É–ª—ñ
2. ‚úÖ –£—Å—É–Ω—É—Ç–∏ –≥–ª–æ–±–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–Ω—ñ
3. ‚úÖ –ü–æ–∫—Ä–∞—â–∏—Ç–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–æ–¥—É
4. ‚úÖ –î–æ–¥–∞—Ç–∏ type hints
5. ‚úÖ –ü–æ–∫—Ä–∞—â–∏—Ç–∏ –æ–±—Ä–æ–±–∫—É –ø–æ–º–∏–ª–æ–∫
6. ‚úÖ –ó–º–µ–Ω—à–∏—Ç–∏ –¥—É–±–ª—é–≤–∞–Ω–Ω—è –∫–æ–¥—É

---

## üìÅ –ù–æ–≤–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç—É

### –ü–æ—Ç–æ—á–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
```
monitor-Ds---X/
‚îú‚îÄ‚îÄ bot.py                          # 7,473 —Ä—è–¥–∫–∏ ‚ùå
‚îú‚îÄ‚îÄ project_manager.py
‚îú‚îÄ‚îÄ access_manager.py
‚îú‚îÄ‚îÄ security_manager.py
‚îú‚îÄ‚îÄ config.py
‚îî‚îÄ‚îÄ ...
```

### –¶—ñ–ª—å–æ–≤–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
```
monitor-Ds---X/
‚îú‚îÄ‚îÄ bot/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ main.py                     # –¢–æ—á–∫–∞ –≤—Ö–æ–¥—É (100 —Ä—è–¥–∫—ñ–≤)
‚îÇ   ‚îú‚îÄ‚îÄ app.py                      # Application setup (150 —Ä—è–¥–∫—ñ–≤)
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ handlers/                   # –û–±—Ä–æ–±–Ω–∏–∫–∏ –∫–æ–º–∞–Ω–¥
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth_handler.py         # –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ project_handler.py      # –ü—Ä–æ–µ–∫—Ç–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ twitter_handler.py      # Twitter
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ discord_handler.py      # Discord
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ selenium_handler.py     # Selenium
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ admin_handler.py        # –ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä—É–≤–∞–Ω–Ω—è
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ menu_handler.py         # –ú–µ–Ω—é
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ keyboards/                  # Inline –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main_keyboard.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ project_keyboard.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ twitter_keyboard.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ admin_keyboard.py
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ services/                   # –ë—ñ–∑–Ω–µ—Å-–ª–æ–≥—ñ–∫–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ monitoring_service.py   # –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –º–æ–Ω—ñ—Ç–æ—Ä—ñ–≤
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ forwarding_service.py   # –ü–µ—Ä–µ—Å–∏–ª–∞–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ project_service.py      # –†–æ–±–æ—Ç–∞ –∑ –ø—Ä–æ–µ–∫—Ç–∞–º–∏
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ middleware/                 # Middleware
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth_middleware.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ rate_limiter.py
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ utils/                      # –£—Ç–∏–ª—ñ—Ç–∏
‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
‚îÇ       ‚îú‚îÄ‚îÄ formatters.py           # –§–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
‚îÇ       ‚îú‚îÄ‚îÄ validators.py           # –í–∞–ª—ñ–¥–∞—Ü—ñ—è
‚îÇ       ‚îî‚îÄ‚îÄ helpers.py              # –î–æ–ø–æ–º—ñ–∂–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó
‚îÇ
‚îú‚îÄ‚îÄ monitors/                       # –ú–æ–Ω—ñ—Ç–æ—Ä–∏
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ base_monitor.py             # –ë–∞–∑–æ–≤–∏–π –∫–ª–∞—Å
‚îÇ   ‚îú‚îÄ‚îÄ twitter_monitor.py
‚îÇ   ‚îú‚îÄ‚îÄ discord_monitor.py
‚îÇ   ‚îú‚îÄ‚îÄ selenium_monitor.py
‚îÇ   ‚îî‚îÄ‚îÄ twitter_adapter.py
‚îÇ
‚îú‚îÄ‚îÄ managers/                       # –ú–µ–Ω–µ–¥–∂–µ—Ä–∏
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ project_manager.py
‚îÇ   ‚îú‚îÄ‚îÄ access_manager.py
‚îÇ   ‚îî‚îÄ‚îÄ security_manager.py
‚îÇ
‚îú‚îÄ‚îÄ models/                         # –ú–æ–¥–µ–ª—ñ –¥–∞–Ω–∏—Ö
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ project.py
‚îÇ   ‚îú‚îÄ‚îÄ user.py
‚îÇ   ‚îî‚îÄ‚îÄ monitoring_state.py
‚îÇ
‚îú‚îÄ‚îÄ database/                       # –ë–î (–º–∞–π–±—É—Ç–Ω—î)
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ connection.py
‚îÇ   ‚îî‚îÄ‚îÄ migrations/
‚îÇ
‚îú‚îÄ‚îÄ tests/                          # –¢–µ—Å—Ç–∏
‚îÇ   ‚îú‚îÄ‚îÄ unit/
‚îÇ   ‚îú‚îÄ‚îÄ integration/
‚îÇ   ‚îî‚îÄ‚îÄ conftest.py
‚îÇ
‚îú‚îÄ‚îÄ config.py
‚îú‚îÄ‚îÄ requirements.txt
‚îî‚îÄ‚îÄ main.py                         # –¢–æ—á–∫–∞ –≤—Ö–æ–¥—É
```

---

## üî® –ü–ª–∞–Ω —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥—É

### –ï—Ç–∞–ø 1: –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ (1 –¥–µ–Ω—å)

#### 1.1. –°—Ç–≤–æ—Ä–∏—Ç–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–∞–ø–æ–∫
```bash
mkdir -p bot/{handlers,keyboards,services,middleware,utils}
mkdir -p monitors managers models database tests/{unit,integration}
```

#### 1.2. –î–æ–¥–∞—Ç–∏ __init__.py —Ñ–∞–π–ª–∏
```bash
find . -type d -exec touch {}/__init__.py \;
```

#### 1.3. –°—Ç–≤–æ—Ä–∏—Ç–∏ git –≥—ñ–ª–∫—É
```bash
git checkout -b refactor/modular-structure
```

---

### –ï—Ç–∞–ø 2: –í–∏–¥—ñ–ª–µ–Ω–Ω—è –º–æ–¥–µ–ª–µ–π (2 –¥–Ω—ñ)

#### 2.1. –°—Ç–≤–æ—Ä–∏—Ç–∏ –º–æ–¥–µ–ª—ñ –¥–∞–Ω–∏—Ö (models/project.py)

**–ë—É–ª–æ:**
```python
# bot.py
project_data = {
    'id': project_id,
    'name': name,
    'type': project_type,
    'url': url,
    'forward_to': forward_to,
    'created_at': datetime.now().isoformat()
}
```

**–°—Ç–∞–ª–æ:**
```python
# models/project.py
from pydantic import BaseModel, validator
from datetime import datetime
from typing import Optional, Literal

class Project(BaseModel):
    id: int
    name: str
    type: Literal['twitter', 'discord']
    url: str
    forward_to: int
    created_at: datetime = datetime.now()
    updated_at: Optional[datetime] = None
    admins: list[int] = []
    
    @validator('url')
    def validate_url(cls, v, values):
        project_type = values.get('type')
        if project_type == 'twitter':
            if not v.startswith(('https://twitter.com/', 'https://x.com/')):
                raise ValueError('Invalid Twitter URL')
        elif project_type == 'discord':
            if not v.startswith('https://discord.com/channels/'):
                raise ValueError('Invalid Discord URL')
        return v
    
    class Config:
        json_encoders = {
            datetime: lambda v: v.isoformat()
        }
```

#### 2.2. –°—Ç–≤–æ—Ä–∏—Ç–∏ –º–æ–¥–µ–ª—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ (models/user.py)

```python
# models/user.py
from pydantic import BaseModel
from datetime import datetime
from typing import Optional, Literal

class User(BaseModel):
    telegram_id: int
    username: str
    access_level: Literal['user', 'admin', 'super_admin'] = 'user'
    permissions: list[str] = []
    created_at: datetime
    last_login: Optional[datetime] = None
    is_active: bool = True
```

---

### –ï—Ç–∞–ø 3: –í–∏–¥—ñ–ª–µ–Ω–Ω—è —Å–µ—Ä–≤—ñ—Å—ñ–≤ (3 –¥–Ω—ñ)

#### 3.1. –°—Ç–≤–æ—Ä–∏—Ç–∏ monitoring_service.py

**–ë—É–ª–æ:** –§—É–Ω–∫—Ü—ñ—ó –≤ bot.py
```python
# bot.py (—Ä—è–¥–∫–∏ 82-200)
def clean_forbidden_accounts():
    ...

async def sync_monitors_with_projects():
    ...

async def start_monitoring():
    ...
```

**–°—Ç–∞–ª–æ:**
```python
# bot/services/monitoring_service.py
from typing import Set, Dict
from managers.project_manager import ProjectManager
from monitors.base_monitor import BaseMonitor

class MonitoringService:
    def __init__(
        self,
        project_manager: ProjectManager,
        monitors: Dict[str, BaseMonitor]
    ):
        self.project_manager = project_manager
        self.monitors = monitors
        self.forbidden_accounts = {'twitter', 'x'}
    
    async def clean_forbidden_accounts(self) -> None:
        """–û—á–∏—Å—Ç–∏—Ç–∏ –∑–∞–±–æ—Ä–æ–Ω–µ–Ω—ñ –∞–∫–∞—É–Ω—Ç–∏"""
        for monitor in self.monitors.values():
            for account in self.forbidden_accounts:
                if account in monitor.monitoring_accounts:
                    monitor.remove_account(account)
    
    async def sync_monitors_with_projects(self) -> None:
        """–°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É–≤–∞—Ç–∏ –º–æ–Ω—ñ—Ç–æ—Ä–∏ –∑ –ø—Ä–æ–µ–∫—Ç–∞–º–∏"""
        all_projects = self.project_manager.get_all_projects()
        
        # –ì—Ä—É–ø—É—î–º–æ –ø—Ä–æ–µ–∫—Ç–∏ –∑–∞ —Ç–∏–ø–æ–º
        twitter_accounts = set()
        discord_channels = set()
        
        for user_projects in all_projects.values():
            for project in user_projects:
                if project['type'] == 'twitter':
                    username = project['url'].split('/')[-1]
                    twitter_accounts.add(username)
                elif project['type'] == 'discord':
                    discord_channels.add(project['url'])
        
        # –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É—î–º–æ –º–æ–Ω—ñ—Ç–æ—Ä–∏
        await self._sync_twitter_monitor(twitter_accounts)
        await self._sync_discord_monitor(discord_channels)
    
    async def _sync_twitter_monitor(self, accounts: Set[str]) -> None:
        """–°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑—É–≤–∞—Ç–∏ Twitter –º–æ–Ω—ñ—Ç–æ—Ä"""
        if 'twitter' not in self.monitors:
            return
        
        monitor = self.monitors['twitter']
        current_accounts = monitor.monitoring_accounts.copy()
        
        # –î–æ–¥–∞—î–º–æ –Ω–æ–≤—ñ –∞–∫–∞—É–Ω—Ç–∏
        for account in accounts - current_accounts:
            await monitor.add_account(account)
        
        # –í–∏–¥–∞–ª—è—î–º–æ —Å—Ç–∞—Ä—ñ –∞–∫–∞—É–Ω—Ç–∏
        for account in current_accounts - accounts:
            monitor.remove_account(account)
```

#### 3.2. –°—Ç–≤–æ—Ä–∏—Ç–∏ forwarding_service.py

```python
# bot/services/forwarding_service.py
import tempfile
import os
from typing import Optional, Dict
from telegram import Bot
from PIL import Image

class ForwardingService:
    def __init__(self, bot: Bot):
        self.bot = bot
    
    async def forward_tweet(
        self,
        channel_id: int,
        tweet_data: Dict,
        project_name: str
    ) -> None:
        """–ü–µ—Ä–µ—Å–ª–∞—Ç–∏ —Ç–≤—ñ—Ç —É –∫–∞–Ω–∞–ª"""
        text = self._format_tweet_message(tweet_data, project_name)
        
        # –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –º–µ–¥—ñ–∞ —è–∫—â–æ —î
        if tweet_data.get('media'):
            await self._send_with_media(channel_id, text, tweet_data['media'])
        else:
            await self.bot.send_message(channel_id, text)
    
    async def forward_discord_message(
        self,
        channel_id: int,
        message_data: Dict,
        project_name: str
    ) -> None:
        """–ü–µ—Ä–µ—Å–ª–∞—Ç–∏ Discord –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —É –∫–∞–Ω–∞–ª"""
        text = self._format_discord_message(message_data, project_name)
        
        if message_data.get('attachments'):
            await self._send_with_attachments(
                channel_id,
                text,
                message_data['attachments']
            )
        else:
            await self.bot.send_message(channel_id, text)
    
    def _format_tweet_message(self, tweet_data: Dict, project_name: str) -> str:
        """–§–æ—Ä–º–∞—Ç—É–≤–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —Ç–≤—ñ—Ç–∞"""
        return (
            f"üê¶ **{project_name}**\n\n"
            f"{tweet_data['text']}\n\n"
            f"üîó {tweet_data['url']}"
        )
```

---

### –ï—Ç–∞–ø 4: –í–∏–¥—ñ–ª–µ–Ω–Ω—è –æ–±—Ä–æ–±–Ω–∏–∫—ñ–≤ (4 –¥–Ω—ñ)

#### 4.1. –°—Ç–≤–æ—Ä–∏—Ç–∏ –±–∞–∑–æ–≤–∏–π –æ–±—Ä–æ–±–Ω–∏–∫ (bot/handlers/base_handler.py)

```python
# bot/handlers/base_handler.py
from abc import ABC, abstractmethod
from telegram import Update
from telegram.ext import ContextTypes
from typing import Optional

class BaseHandler(ABC):
    """–ë–∞–∑–æ–≤–∏–π –∫–ª–∞—Å –¥–ª—è –≤—Å—ñ—Ö –æ–±—Ä–æ–±–Ω–∏–∫—ñ–≤"""
    
    def __init__(self, **dependencies):
        """–Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∑ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—è–º–∏"""
        for key, value in dependencies.items():
            setattr(self, key, value)
    
    @abstractmethod
    async def handle(
        self,
        update: Update,
        context: ContextTypes.DEFAULT_TYPE
    ) -> None:
        """–ì–æ–ª–æ–≤–Ω–∏–π –º–µ—Ç–æ–¥ –æ–±—Ä–æ–±–∫–∏"""
        pass
    
    def _get_user_id(self, update: Update) -> Optional[int]:
        """–û—Ç—Ä–∏–º–∞—Ç–∏ ID –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞"""
        return update.effective_user.id if update.effective_user else None
```

#### 4.2. –°—Ç–≤–æ—Ä–∏—Ç–∏ project_handler.py

**–ë—É–ª–æ:** –§—É–Ω–∫—Ü—ñ—ó –≤ bot.py
```python
# bot.py (—Ä—è–¥–∫–∏ 500-1000)
async def show_projects_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    ...

async def add_project_start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    ...

async def delete_project(update: Update, context: ContextTypes.DEFAULT_TYPE):
    ...
```

**–°—Ç–∞–ª–æ:**
```python
# bot/handlers/project_handler.py
from .base_handler import BaseHandler
from managers.project_manager import ProjectManager
from bot.keyboards.project_keyboard import ProjectKeyboard

class ProjectHandler(BaseHandler):
    def __init__(
        self,
        project_manager: ProjectManager,
        keyboard: ProjectKeyboard
    ):
        self.project_manager = project_manager
        self.keyboard = keyboard
    
    async def show_projects_menu(
        self,
        update: Update,
        context: ContextTypes.DEFAULT_TYPE
    ) -> None:
        """–ü–æ–∫–∞–∑–∞—Ç–∏ –º–µ–Ω—é –ø—Ä–æ–µ–∫—Ç—ñ–≤"""
        user_id = self._get_user_id(update)
        projects = self.project_manager.get_user_projects(user_id)
        
        keyboard = self.keyboard.create_projects_list(projects)
        
        await update.message.reply_text(
            "üìÅ **–í–∞—à—ñ –ø—Ä–æ–µ–∫—Ç–∏:**",
            reply_markup=keyboard
        )
    
    async def add_project_start(
        self,
        update: Update,
        context: ContextTypes.DEFAULT_TYPE
    ) -> None:
        """–ü–æ—á–∞—Ç–æ–∫ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –ø—Ä–æ–µ–∫—Ç—É"""
        keyboard = self.keyboard.create_project_type_selector()
        
        await update.message.reply_text(
            "üìù **–í–∏–±–µ—Ä—ñ—Ç—å —Ç–∏–ø –ø—Ä–æ–µ–∫—Ç—É:**",
            reply_markup=keyboard
        )
    
    async def delete_project(
        self,
        update: Update,
        context: ContextTypes.DEFAULT_TYPE,
        project_id: int
    ) -> None:
        """–í–∏–¥–∞–ª–∏—Ç–∏ –ø—Ä–æ–µ–∫—Ç"""
        user_id = self._get_user_id(update)
        
        success = self.project_manager.delete_project(user_id, project_id)
        
        if success:
            await update.callback_query.answer("‚úÖ –ü—Ä–æ–µ–∫—Ç –≤–∏–¥–∞–ª–µ–Ω–æ")
        else:
            await update.callback_query.answer("‚ùå –ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è")
```

---

### –ï—Ç–∞–ø 5: –í–∏–¥—ñ–ª–µ–Ω–Ω—è –∫–ª–∞–≤—ñ–∞—Ç—É—Ä (2 –¥–Ω—ñ)

#### 5.1. –°—Ç–≤–æ—Ä–∏—Ç–∏ project_keyboard.py

**–ë—É–ª–æ:**
```python
# bot.py
keyboard = InlineKeyboardMarkup([
    [InlineKeyboardButton("üìÅ –ú–æ—ó –ø—Ä–æ–µ–∫—Ç–∏", callback_data='projects')],
    [InlineKeyboardButton("‚ûï –î–æ–¥–∞—Ç–∏ –ø—Ä–æ–µ–∫—Ç", callback_data='add_project')],
    ...
])
```

**–°—Ç–∞–ª–æ:**
```python
# bot/keyboards/project_keyboard.py
from telegram import InlineKeyboardButton, InlineKeyboardMarkup
from typing import List, Dict

class ProjectKeyboard:
    @staticmethod
    def create_projects_list(projects: List[Dict]) -> InlineKeyboardMarkup:
        """–°—Ç–≤–æ—Ä–∏—Ç–∏ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä—É –∑—ñ —Å–ø–∏—Å–∫–æ–º –ø—Ä–æ–µ–∫—Ç—ñ–≤"""
        buttons = []
        
        for project in projects:
            emoji = "üê¶" if project['type'] == 'twitter' else "üí¨"
            buttons.append([
                InlineKeyboardButton(
                    f"{emoji} {project['name']}",
                    callback_data=f"project_{project['id']}"
                )
            ])
        
        buttons.append([
            InlineKeyboardButton("‚ûï –î–æ–¥–∞—Ç–∏ –ø—Ä–æ–µ–∫—Ç", callback_data='add_project')
        ])
        buttons.append([
            InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data='main_menu')
        ])
        
        return InlineKeyboardMarkup(buttons)
    
    @staticmethod
    def create_project_type_selector() -> InlineKeyboardMarkup:
        """–ö–ª–∞–≤—ñ–∞—Ç—É—Ä–∞ –≤–∏–±–æ—Ä—É —Ç–∏–ø—É –ø—Ä–æ–µ–∫—Ç—É"""
        return InlineKeyboardMarkup([
            [InlineKeyboardButton("üê¶ Twitter", callback_data='project_type_twitter')],
            [InlineKeyboardButton("üí¨ Discord", callback_data='project_type_discord')],
            [InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data='projects')]
        ])
```

---

### –ï—Ç–∞–ø 6: –°—Ç–≤–æ—Ä–µ–Ω–Ω—è Application (2 –¥–Ω—ñ)

#### 6.1. –°—Ç–≤–æ—Ä–∏—Ç–∏ bot/app.py

```python
# bot/app.py
from telegram.ext import Application, CommandHandler, CallbackQueryHandler
from managers.project_manager import ProjectManager
from managers.access_manager import AccessManager
from bot.handlers.project_handler import ProjectHandler
from bot.handlers.twitter_handler import TwitterHandler
from bot.services.monitoring_service import MonitoringService
from config import BOT_TOKEN

class BotApplication:
    def __init__(self):
        # –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –º–µ–Ω–µ–¥–∂–µ—Ä—ñ–≤
        self.project_manager = ProjectManager()
        self.access_manager = AccessManager()
        
        # –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —Å–µ—Ä–≤—ñ—Å—ñ–≤
        self.monitoring_service = MonitoringService(
            project_manager=self.project_manager,
            monitors={}  # –±—É–¥—É—Ç—å –¥–æ–¥–∞–Ω—ñ –ø—ñ–∑–Ω—ñ—à–µ
        )
        
        # –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –æ–±—Ä–æ–±–Ω–∏–∫—ñ–≤
        self.project_handler = ProjectHandler(
            project_manager=self.project_manager
        )
        self.twitter_handler = TwitterHandler(...)
        
        # Telegram Application
        self.app = Application.builder().token(BOT_TOKEN).build()
        
        self._register_handlers()
    
    def _register_handlers(self):
        """–†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –æ–±—Ä–æ–±–Ω–∏–∫—ñ–≤ –∫–æ–º–∞–Ω–¥"""
        # –ö–æ–º–∞–Ω–¥–∏
        self.app.add_handler(CommandHandler("start", self._start))
        self.app.add_handler(CommandHandler("projects", self.project_handler.show_projects_menu))
        
        # Callback queries
        self.app.add_handler(CallbackQueryHandler(
            self._handle_callback,
            pattern='^.*$'
        ))
    
    async def _handle_callback(self, update, context):
        """–ì–æ–ª–æ–≤–Ω–∏–π –æ–±—Ä–æ–±–Ω–∏–∫ callback'—ñ–≤"""
        query = update.callback_query
        data = query.data
        
        # –†–æ—É—Ç–∏–Ω–≥ callback'—ñ–≤
        if data.startswith('project_'):
            await self.project_handler.handle_project_callback(update, context)
        elif data.startswith('twitter_'):
            await self.twitter_handler.handle_twitter_callback(update, context)
        # ...
    
    def run(self):
        """–ó–∞–ø—É—Å—Ç–∏—Ç–∏ –±–æ—Ç–∞"""
        self.app.run_polling()
```

#### 6.2. –°—Ç–≤–æ—Ä–∏—Ç–∏ main.py

```python
# main.py
import logging
from bot.app import BotApplication

logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)

def main():
    """–¢–æ—á–∫–∞ –≤—Ö–æ–¥—É"""
    app = BotApplication()
    app.run()

if __name__ == '__main__':
    main()
```

---

### –ï—Ç–∞–ø 7: –ú—ñ–≥—Ä–∞—Ü—ñ—è –¥–∞–Ω–∏—Ö (1 –¥–µ–Ω—å)

#### 7.1. –°—Ç–≤–æ—Ä–∏—Ç–∏ –º—ñ–≥—Ä–∞—Ü—ñ—ó

```python
# database/migrations/001_initial.py
import json
import sqlite3

def migrate_from_json_to_sqlite():
    """–ú—ñ–≥—Ä—É–≤–∞—Ç–∏ –¥–∞–Ω—ñ –∑ JSON –≤ SQLite"""
    # –ß–∏—Ç–∞—î–º–æ —Å—Ç–∞—Ä—ñ –¥–∞–Ω—ñ
    with open('data.json', 'r') as f:
        old_data = json.load(f)
    
    # –°—Ç–≤–æ—Ä—é—î–º–æ –ë–î
    conn = sqlite3.connect('bot_data.db')
    cursor = conn.cursor()
    
    # –°—Ç–≤–æ—Ä—é—î–º–æ —Ç–∞–±–ª–∏—Ü—ñ
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS projects (
            id INTEGER PRIMARY KEY,
            user_id INTEGER NOT NULL,
            name TEXT NOT NULL,
            type TEXT NOT NULL,
            url TEXT NOT NULL,
            forward_to INTEGER NOT NULL,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    ''')
    
    # –ú—ñ–≥—Ä—É—î–º–æ –ø—Ä–æ–µ–∫—Ç–∏
    for user_id, projects in old_data['projects'].items():
        for project in projects:
            cursor.execute('''
                INSERT INTO projects (id, user_id, name, type, url, forward_to)
                VALUES (?, ?, ?, ?, ?, ?)
            ''', (
                project['id'],
                int(user_id),
                project['name'],
                project['type'],
                project['url'],
                project['forward_to']
            ))
    
    conn.commit()
    conn.close()
```

---

## üìä –ü—Ä–æ–≥—Ä–µ—Å —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥—É

### –ß–µ–∫–ª—ñ—Å—Ç

#### –ï—Ç–∞–ø 1: –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞
- [ ] –°—Ç–≤–æ—Ä–∏—Ç–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–∞–ø–æ–∫
- [ ] –î–æ–¥–∞—Ç–∏ __init__.py —Ñ–∞–π–ª–∏
- [ ] –°—Ç–≤–æ—Ä–∏—Ç–∏ git –≥—ñ–ª–∫—É

#### –ï—Ç–∞–ø 2: –ú–æ–¥–µ–ª—ñ
- [ ] –°—Ç–≤–æ—Ä–∏—Ç–∏ models/project.py
- [ ] –°—Ç–≤–æ—Ä–∏—Ç–∏ models/user.py
- [ ] –î–æ–¥–∞—Ç–∏ –≤–∞–ª—ñ–¥–∞—Ü—ñ—é

#### –ï—Ç–∞–ø 3: –°–µ—Ä–≤—ñ—Å–∏
- [ ] –°—Ç–≤–æ—Ä–∏—Ç–∏ monitoring_service.py
- [ ] –°—Ç–≤–æ—Ä–∏—Ç–∏ forwarding_service.py
- [ ] –°—Ç–≤–æ—Ä–∏—Ç–∏ project_service.py

#### –ï—Ç–∞–ø 4: –û–±—Ä–æ–±–Ω–∏–∫–∏
- [ ] –°—Ç–≤–æ—Ä–∏—Ç–∏ base_handler.py
- [ ] –°—Ç–≤–æ—Ä–∏—Ç–∏ project_handler.py
- [ ] –°—Ç–≤–æ—Ä–∏—Ç–∏ twitter_handler.py
- [ ] –°—Ç–≤–æ—Ä–∏—Ç–∏ discord_handler.py
- [ ] –°—Ç–≤–æ—Ä–∏—Ç–∏ auth_handler.py

#### –ï—Ç–∞–ø 5: –ö–ª–∞–≤—ñ–∞—Ç—É—Ä–∏
- [ ] –°—Ç–≤–æ—Ä–∏—Ç–∏ project_keyboard.py
- [ ] –°—Ç–≤–æ—Ä–∏—Ç–∏ main_keyboard.py
- [ ] –°—Ç–≤–æ—Ä–∏—Ç–∏ twitter_keyboard.py

#### –ï—Ç–∞–ø 6: Application
- [ ] –°—Ç–≤–æ—Ä–∏—Ç–∏ bot/app.py
- [ ] –°—Ç–≤–æ—Ä–∏—Ç–∏ main.py
- [ ] –ù–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ DI (Dependency Injection)

#### –ï—Ç–∞–ø 7: –ú—ñ–≥—Ä–∞—Ü—ñ—è
- [ ] –°—Ç–≤–æ—Ä–∏—Ç–∏ –º—ñ–≥—Ä–∞—Ü—ñ—ó
- [ ] –¢–µ—Å—Ç—É–≤–∞—Ç–∏ –º—ñ–≥—Ä–∞—Ü—ñ—é
- [ ] Backup —Å—Ç–∞—Ä–∏—Ö –¥–∞–Ω–∏—Ö

#### –ï—Ç–∞–ø 8: –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è
- [ ] Unit —Ç–µ—Å—Ç–∏ –¥–ª—è —Å–µ—Ä–≤—ñ—Å—ñ–≤
- [ ] Integration —Ç–µ—Å—Ç–∏
- [ ] E2E —Ç–µ—Å—Ç–∏

---

## üéØ –û—á—ñ–∫—É–≤–∞–Ω—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏

### –ú–µ—Ç—Ä–∏–∫–∏

| –ú–µ—Ç—Ä–∏–∫–∞ | –ë—É–ª–æ | –°—Ç–∞–Ω–µ | –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è |
|---------|------|-------|------------|
| –†–æ–∑–º—ñ—Ä bot.py | 7,473 —Ä—è–¥–∫–∏ | ~200 —Ä—è–¥–∫—ñ–≤ | -97% |
| –ö—ñ–ª—å–∫—ñ—Å—Ç—å —Ñ–∞–π–ª—ñ–≤ | 15 | 50+ | +233% |
| –°–µ—Ä–µ–¥–Ω—ñ–π —Ä–æ–∑–º—ñ—Ä —Ñ–∞–π–ª—É | ~830 —Ä—è–¥–∫—ñ–≤ | ~150 —Ä—è–¥–∫—ñ–≤ | -82% |
| –ì–ª–æ–±–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–Ω—ñ | 10+ | 0 | -100% |
| Code coverage | 0% | 80%+ | +80% |

### –ü–µ—Ä–µ–≤–∞–≥–∏ –ø—ñ—Å–ª—è —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥—É

1. ‚úÖ **–ü—ñ–¥—Ç—Ä–∏–º—É–≤–∞–Ω—ñ—Å—Ç—å** - –õ–µ–≥—à–µ –∑–Ω–∞–π—Ç–∏ —ñ –∑–º—ñ–Ω–∏—Ç–∏ –∫–æ–¥
2. ‚úÖ **–¢–µ—Å—Ç–æ–≤–∞–Ω—ñ—Å—Ç—å** - –ú–æ–∂–Ω–∞ —Ç–µ—Å—Ç—É–≤–∞—Ç–∏ –æ–∫—Ä–µ–º—ñ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∏
3. ‚úÖ **–ú–∞—Å—à—Ç–∞–±–æ–≤–∞–Ω—ñ—Å—Ç—å** - –õ–µ–≥–∫–æ –¥–æ–¥–∞–≤–∞—Ç–∏ –Ω–æ–≤—ñ —Ñ—É–Ω–∫—Ü—ñ—ó
4. ‚úÖ **–ß–∏—Ç–∞–±–µ–ª—å–Ω—ñ—Å—Ç—å** - –ó—Ä–æ–∑—É–º—ñ–ª–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞
5. ‚úÖ **–ü–µ—Ä–µ—É—Å–Ω—ñ—Å—Ç—å** - –ö–æ–º–ø–æ–Ω–µ–Ω—Ç–∏ –º–æ–∂–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ

---

## ‚ö†Ô∏è –†–∏–∑–∏–∫–∏ —ñ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó

### –†–∏–∑–∏–∫–∏
1. üî¥ –ú–æ–∂–ª–∏–≤—ñ –±–∞–≥–∏ –ø—Ä–∏ –º—ñ–≥—Ä–∞—Ü—ñ—ó
2. üü° –ß–∞—Å –Ω–∞ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ (~2 —Ç–∏–∂–Ω—ñ)
3. üü° –ü–æ—Ç—Ä—ñ–±–Ω–æ –Ω–∞–≤—á–∏—Ç–∏—Å—è –Ω–æ–≤—ñ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ñ

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ—ó
1. ‚úÖ –ó—Ä–æ–±–∏—Ç–∏ backup –ø–µ—Ä–µ–¥ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–æ–º
2. ‚úÖ –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏—Ç–∏ –ø–æ –æ–¥–Ω–æ–º—É –º–æ–¥—É–ª—é
3. ‚úÖ –ü–∏—Å–∞—Ç–∏ —Ç–µ—Å—Ç–∏ –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ –º–æ–¥—É–ª—è
4. ‚úÖ Code review –ø—ñ—Å–ª—è –∫–æ–∂–Ω–æ–≥–æ –µ—Ç–∞–ø—É
5. ‚úÖ Documenta –Ω–æ–≤—É —Å—Ç—Ä—É–∫—Ç—É—Ä—É

---

**–î–∞—Ç–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è:** –ì—Ä—É–¥–µ–Ω—å 2024  
**–í–µ—Ä—Å—ñ—è:** 1.0  
**–ê–≤—Ç–æ—Ä:** Refactoring Guide
